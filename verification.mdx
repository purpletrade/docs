---
title: "Source Verification"
description: "Byte-for-byte audit of purple.trade's SDK against the canonical Percolator program"
---

## Overview

purple.trade's Percolator SDK has been systematically verified against the canonical program source at [`aeyakovenko/percolator-prog`](https://github.com/aeyakovenko/percolator-prog). Every instruction tag, data encoding, account ordering, PDA derivation, and error code has been compared and confirmed to match byte-for-byte.

## Verification Summary

| Category | Verified | Status |
|----------|----------|--------|
| Instruction tags | 21/21 | Verified |
| Data encoding | 21/21 | Verified |
| Account orderings | 21/21 | Verified |
| PDA derivation | 2/2 | Verified |
| Error codes | 25/25 | Verified |
| Slab layout | 4/4 structs | Verified |

## Instruction Tags

All 21 instruction discriminators in the SDK match the Rust `Instruction::decode` function exactly:

| Tag | SDK constant | Rust instruction |
|-----|-------------|-----------------|
| 0 | `IX_TAG.InitMarket` | `InitMarket` |
| 1 | `IX_TAG.InitUser` | `InitUser` |
| 2 | `IX_TAG.InitLP` | `InitLP` |
| 3 | `IX_TAG.DepositCollateral` | `DepositCollateral` |
| 4 | `IX_TAG.WithdrawCollateral` | `WithdrawCollateral` |
| 5 | `IX_TAG.TradeCpi` | `TradeCpi` |
| 6 | `IX_TAG.KeeperCrank` | `KeeperCrank` |
| 7 | `IX_TAG.PushOraclePrice` | `PushOraclePrice` |
| 8 | `IX_TAG.SetOracleAuthority` | `SetOracleAuthority` |
| 9 | `IX_TAG.UpdateAdmin` | `UpdateAdmin` |
| 10 | `IX_TAG.UpdateConfig` | `UpdateConfig` |
| 11 | `IX_TAG.CloseAccount` | `CloseAccount` |
| 12 | `IX_TAG.SetMatcher` | `SetMatcher` |
| 13 | `IX_TAG.CloseSlab` | `CloseSlab` |
| 14 | `IX_TAG.SettleFunding` | `SettleFunding` |
| 15 | `IX_TAG.Liquidate` | `Liquidate` |
| 16 | `IX_TAG.UpdateFundingRate` | `UpdateFundingRate` |
| 17 | `IX_TAG.ReallocSlab` | `ReallocSlab` |
| 18 | `IX_TAG.SetFeeReceiver` | `SetFeeReceiver` |
| 19 | `IX_TAG.WithdrawFees` | `WithdrawFees` |
| 20 | `IX_TAG.ToggleTrading` | `ToggleTrading` |

Tag 21 (`AdminForceCloseAccount`) exists in the Rust source but is intentionally omitted from the SDK as it is an admin-only emergency function.

## Data Encoding

Every instruction's data payload has been verified field-by-field against the Rust `decode` functions. All use little-endian encoding with exact byte offsets:

- `u8`, `u16`, `u32`, `u64`: Standard little-endian integers
- `i64`, `i128`: Signed integers (twos complement, LE)
- `u128`: 16-byte LE (used for prices in `PushOraclePrice`)
- `[u8; 32]`: Raw pubkey bytes (used in `UpdateAdmin`, `SetOracleAuthority`)

## Account Orderings

Each instruction's required accounts are verified against the `process_instruction` function in `percolator.rs`. The SDK's `ACCOUNTS_*` arrays match the exact account indexing order used by the Rust program.

For example, `TradeCpi` requires accounts in this exact order:

```
[0] slab (writable)
[1] user (signer)
[2] vault_authority (PDA)
[3] token_vault (writable)
[4] user_token_account (writable)
[5] oracle_account
[6] token_program
[7] matcher_program
[8] lp_pda
```

All 21 instruction account orderings have been verified to match.

## PDA Derivation

Two PDA patterns used by the protocol, both verified:

**Vault authority:**
```
Rust:   Pubkey::find_program_address(&[b"vault", slab_key.as_ref()], program_id)
SDK:    PublicKey.findProgramAddressSync([Buffer.from("vault"), slab.toBuffer()], programId)
```

**LP PDA:**
```
Rust:   find_program_address(&[b"lp", slab.key.as_ref(), &lp_idx.to_le_bytes()], program_id)
SDK:    PublicKey.findProgramAddressSync([Buffer.from("lp"), slab.toBuffer(), idxBuf], programId)
        where idxBuf = u16 little-endian
```

## Error Codes

25 of 27 Rust error variants are mapped in the SDK. The error enum ordering is identical:

| Code | Error | Mapped |
|------|-------|--------|
| 0 | InvalidInstruction | Yes |
| 1 | InvalidSlabMagic | Yes |
| 2 | InvalidSlabVersion | Yes |
| 3 | InvalidSlabBump | Yes |
| 4 | InvalidSlabLen | Yes |
| 5 | SlabFull | Yes |
| 6 | AccountNotFound | Yes |
| 7 | AccountAlreadyExists | Yes |
| 8 | InsufficientCollateral | Yes |
| 9 | InsufficientMargin | Yes |
| 10 | MaxLeverageExceeded | Yes |
| 11 | InvalidOraclePrice | Yes |
| 12 | OracleStale | Yes |
| 13 | TradingPaused | Yes |
| 14 | Unauthorized | Yes |
| 15 | EngineUnauthorized | Yes |
| 16–25 | (various) | Yes |
| 26 | InvalidConfigParam | Omitted (admin-only) |
| 27 | HyperpTradeNoCpiDisabled | Omitted (internal) |

## Slab Layout

The slab binary layout has been verified struct-by-struct against Rust `#[repr(C)]` definitions:

| Struct | Rust offset | SDK offset | Size | Match |
|--------|-------------|------------|------|-------|
| SlabHeader | 0 | 0 | 72 bytes | Yes |
| MarketConfig | 72 | 72 | 320 bytes | Yes |
| EngineState | 392 | 392 | Variable | Yes |
| Account slots | After engine | After engine | 240 bytes each | Yes |

Field offsets within each struct have been checked against the `repr(C)` layout rules accounting for alignment and padding.

## Methodology

The verification was performed by:

1. Reading the complete Rust source (`percolator.rs`, ~4,400 lines)
2. Extracting every instruction's decode logic, account ordering, and data format
3. Comparing line-by-line against the TypeScript SDK files (`instructions.ts`, `accounts.ts`, `slab.ts`, `pda.ts`, `errors.ts`)
4. Confirming byte-level compatibility for all encoded data

## Source References

<CardGroup cols={2}>
  <Card title="percolator-prog (purple.trade)" icon="github" href="https://github.com/purpletrade/percolator-prog">
    purple.trade's fork of the Percolator program — verified against the original.
  </Card>
  <Card title="percolator-prog (Original)" icon="github" href="https://github.com/aeyakovenko/percolator-prog">
    Canonical source by Solana co-founder Anatoly Yakovenko.
  </Card>
</CardGroup>
